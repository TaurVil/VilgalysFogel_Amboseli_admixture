## Assesssing local ancestry calling using pedigree trios

This directory contains multiple scripts for evaluating the quality of local ancestry calls from LCLAE using known parent-offspring trios from the Amboseli baboons (Supplementary Methods 7.3).

In the Supplementary Methods, we report results comparing the consistency of ancestry calls in pedigree trios between ancestry generated using the high-coverage SNPRC reference panel (the ancestry calls used in all main text analyses) and ancestry generated using the low-coverage reference panel used by Wall et al. 2016 _Molecular Ecology_, supplemented with 11 higher coverage Mikumi samples (5 of which were higher coverage data from individuals already sequenced by Wall et al.). This directory contains scripts and references to the ancestry calls generated from the SNPRC reference panel. However, these scripts can easily be tailored to recreating our results using ancestry calls generated by Wall et al. In DATA, we provide the list of individuals we used for this second reference panel (Wallanubis.list and Wallyellow.list) which can then be used to generate ancestry calls using the vcf, `merged_shared.vcf.gz`, in Section 1 and the LCLAE local ancestry calling pipeline detailed in the scripts in Section 02.1. In DATA, we also provide the pedigree inconsistency results for both reference panels (`local_ancestry_pedigree_trios_maskedSNPRCref.Rd` and `inconsistent_local_ancestry_calls_pedigree_trios_unmaskedWallref.Rd`) generated by the script `run.03` so that Figure S3D, which compares the results from both reference panels, can be recreated.  

#### Get pedigree inconsistences for the pedigree inconsistencies model (scripts labelled run.01-run.03...).

In R, run `run.01.prep_for_pedigree_inconsistencies.R` which generates the R data file, `local_ancestry_pedigree_trios_maskedSNPRCref.Rd`, containing tracts, pedigree trio info, list of pedigree individuals, and genomic positions for evaluating the consistency of ancestry calls within pedigree trios using the SNPRC reference panel. This script uses `amboseli_LCLAE_tracts.txt` generated in Section 02.1. The R data file generated by this script can then be uploaded to a computing cluster for parallelization across chromosomes (which will make things run much faster).

Next, in a directory on a computing cluster containing the R data file, run the R script `run.02.get_ancestry_calls_SNPRCref.R` using the commands below in order to generate chromosome-specific scripts. This script will generate chromosome-specific files containing the ancestry calls for each individual in the pedigree analysis at each of the focal positions across the genome (defined by the `positions` data frame created in `run.01.prep_for_pedigree_inconsistencies.R`):

```console 
# R must be loaded in your computing environment (e.g., module load R, activate a conda environment with R loaded, etc.)
for f in `cat autosomes.list`; do sed -e s/CHROMOSOME/$f/g run.02.get_ancestry_calls_SNPRCref.R > g.$f.sh; sbatch --mem=300 g.$f.sh; done;
rm g.*.sh

# can check that all scripts ran by looking for "done" written in the output files
grep "done" slurm* | wc -l #20 = the number of total scripts we ran so everything ran to completion

# Concatenate the output of the chromosome-specific files into a single file
# Remove the header of each file
for file in ancestry_calls_maskedSNPRCref*; do tail -n +2 "$file" >> "nohead.$file" ; done
# Grab the header from one of the original files which have a header (all files should have the same header so it should not matter which chromosome-specific file you choose) - let's use chromosome 1's header
head -1 ancestry_calls_maskedSNPRCref_pedigree_trios_35kbpos_chr1.txt >> header
# Concatenate the header and all of the header-less files into a single file
cat header nohead.* >> all.ancestry_calls_maskedSNPRCref_pedigree_trios_35kbpos.txt; rm *head*

# Delete chromosome-specific files as these results are now stored in the single file, `all.ancestry_calls_maskedSNPRCref_pedigree_trios_35kbpos.txt`, generated above
rm ancestry*

# Check that we have the expected number of total lines in the concatenated file (should equal the total number of positions + header = 73975 + 1 = 73976)
wc -l all* #73976 all.ancestry_calls_maskedSNPRCref_pedigree_trios_35kbpos.txt
```

In the same directory, run the R script `run.03.get_ped_inconsistencies_SNPRCref.R` to identify inconsistent ancestry calls using the pedigree structure.

```console 
sbatch --mem=1G  run.03.get_ped_inconsistencies_SNPRCref.R

# can check that the script ran by looking for "done" written in the output file
grep "done" slurm* | wc -l #1 = the number of total scripts we ran so everything ran to completion
```

#### Get covariates for the pedigree inconsistencies model (scripts labelled with a run.04...)

For each genomic window, we would also like to get information on the number of (1) ancestry informative markers, (2) FST, and (3) recombination rate which we will include as covariates in our model of pedigree inconsistencies. 

**(1) ANCESTRY INFORMATIVE MARKERS (AIMS)**: run the R script `run.04a.AIM_count_SNPRCref.R` using the command below in order to generate chromosome-specific scripts. This script requires majority rule ancestry calls across Amboseli individuals, split into chromosome specific files. To generate these files, take the `amboseli.majrule.txt` output generated in Section 02.1 and split into chromosome-specific files by:
```console
awk '{OFS="\t"; print >> ("aims_" $1 ".txt")}' amboseli.majrule.txt # generates chromosome-specific files of ancestry calls across all Amboseli individuals 

for f in `seq 1 20`; do sed -e s/CHROMOSOME/$f/g run.04a.AIM_count_SNPRCref.R > g.$f.sh; sbatch --mem=30000 g.$f.sh; done
rm g.*.sh

# check that all scripts ran by looking for "done" written in the output files
grep "done" slurm* | wc -l #20 = the number of total scripts we ran so everything ran to completion

# concatenate the output of the chromosome-specific files into a single file
cat for_pedigree_trios_AIM_count_maskedSNPRCref_pedigree_trios_chr* >> all.for_pedigree_trios_AIM_count_maskedSNPRCref_pedigree_trios.txt

# Check that we have the expected number of total lines (should equal the total number of positions = 73975)
wc -l all.for_pedigree_trios_AIM_count*
#73975 all.for_pedigree_trios_AIM_count_maskedSNPRCref_pedigree_trios.txt
  
# Remove chromosome-specific files
rm for_pedigree_trios_AIM_count*txt
```

**(2) FST**: use the script `run.04b.FST_SNPRCref.sh` to calculate FST using vcftools with 35 kb windows and 500 bp step size
```console
sbatch --mem=500 run.04b.FST_SNPRCref.sh
```

**(3) RECOMBINATION RATE**: run the R script from `run.04c.Recomb.R` which is almost identical to the code in `Section 05, run.01`, but modified for the input for this analysis, the positions in this analysis (in the positions data frame), and the output (we also want the lengths used in the calculation).
```console
sbatch --mem=200 run.04c.Recomb.R
```

#### Pedigree inconsistency results (script labelled with a run.05...)

Finally, in a directory containing all files generated up to this point, run `run.05.pedigree_inconsistencies_results.R` which calculates, compares, and plots the proportion of ancestry state inconsistencies in pedigree trios using ancestry calls from the SNPRC reference panel and the Wall et al. reference panel supplemented with higher coverage individuals. It also runs a model to evaluate what predicts ancestry state inconsistencies across sites. Finally, it evaluates the proportion of ancestry state inconsistencies per pedigree trio and whether the minimum coverage of individuals in the trio might contribute to it. 
